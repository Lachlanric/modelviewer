<head>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div style="display: flex">
    <div class="section">
      <div style="display: flex">
        <div class="section-60">
          <h4 class="heading">Stabiliser parameters</h4>

          <table border="1" cellpadding="5" cellspacing="0" class="param-table">
            <thead>
              <tr>
                <th></th>
                <th>Roll</th>
                <th>Pitch</th>
                <th>Yaw</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>P</td>
                <td><input type="number" step="any" id="roll_p" name="roll_p" value="1.0" /></td>
                <td><input type="number" step="any" id="pitch_p" name="pitch_p" value="1.0" /></td>
                <td><input type="number" step="any" id="yaw_p" name="yaw_p" value="1.0" /></td>
              </tr>
              <tr>
                <td>I</td>
                <td><input type="number" step="any" id="roll_i" name="roll_i" value="0.0" /></td>
                <td><input type="number" step="any" id="pitch_i" name="pitch_i" value="0.0" /></td>
                <td><input type="number" step="any" id="yaw_i" name="yaw_i" value="0.0" /></td>
              </tr>
              <tr>
                <td>D</td>
                <td><input type="number" step="any" id="roll_d" name="roll_d" value="0.0" /></td>
                <td><input type="number" step="any" id="pitch_d" name="pitch_d" value="0.0" /></td>
                <td><input type="number" step="any" id="yaw_d" name="yaw_d" value="0.0" /></td>
              </tr>
              <tr>
                <td>Integral Limit</td>
                <td><input type="number" step="any" id="roll_integral_limit" name="roll_integral_limit" value="0.0" /></td>
                <td>
                  <input type="number" step="any" id="pitch_integral_limit" name="pitch_integral_limit" value="0.0" />
                </td>
                <td><input type="number" step="any" id="yaw_integral_limit" name="yaw_integral_limit" value="0.0" /></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="section-40">
          <h4 class="heading">Serial Connection</h4>

          <div style="display: flex; gap: 0.5rem">
            <button id="serial_refresh">â†»</button>
            <select id="serial_port" name="serial_port">
              <option value="COM--">COM--</option>
            </select>
            <button id="serial_open">Open</button>
            <button id="serial_close">Close</button>
          </div>

          <br />
          <b>Hint -</b> If the controller is not reconnecting:
          <ul style="margin-top: 0">
            <li>Click Close</li>
            <li>Reboot controller</li>
            <li>Click Open</li>
          </ul>
        </div>
      </div>

      <table border="1" cellpadding="5" cellspacing="0" class="param-table">
        <thead>
          <tr>
            <th></th>
            <th>NW</th>
            <th>NE</th>
            <th>SW</th>
            <th>SE</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Motor scale</td>
            <td><input type="number" step="0.01" id="nw_scale" name="nw_scale" value="1" /></td>
            <td><input type="number" step="0.01" id="ne_scale" name="ne_scale" value="1" /></td>
            <td><input type="number" step="0.01" id="sw_scale" name="sw_scale" value="1" /></td>
            <td><input type="number" step="0.01" id="se_scale" name="se_scale" value="1" /></td>
          </tr>
        </tbody>
      </table>

      <table border="1" cellpadding="5" cellspacing="0" class="param-table">
        <thead>
          <tr>
            <th></th>
            <th>Forward</th>
            <th>Backward</th>
            <th>Left</th>
            <th>Right</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Target angle (deg)</td>
            <td><input type="number" step="1.0" id="forward_angle" name="forward_angle" value="20.0" /></td>
            <td><input type="number" step="1.0" id="backward_angle" name="backward_angle" value="20.0" /></td>
            <td><input type="number" step="1.0" id="left_angle" name="left_angle" value="20.0" /></td>
            <td><input type="number" step="1.0" id="right_angle" name="right_angle" value="20.0" /></td>
          </tr>
        </tbody>
      </table>

      <table border="1" cellpadding="5" cellspacing="0" class="param-table">
        <thead>
          <tr>
            <th></th>
            <th>Deadzone</th>
            <th>Speed (deg/s)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Yaw control</td>
            <td><input type="number" step="1.0" id="yaw_deadzone" name="yaw_deadzone" value="0.7" /></td>
            <td><input type="number" step="1.0" id="yaw_speed" name="yaw_speed" value="180.0" /></td>
          </tr>
        </tbody>
      </table>

      <tbody>
        <tr>
          <td></td>
        </tr>
      </tbody>

      <button class="action-button" id="update_params">Save params</button>
      <button class="action-button" id="obtain_params">Load params from drone</button>

      <br />

      <div style="display: flex">
        <div class="section-30">
          <h4 class="heading">Drone orientation</h4>

          <model-viewer src="models/droneassem1.glb" ar shadow-intensity="1" orientation="0deg 0deg 0deg" style="width: 100%; height: 20vh"></model-viewer>
        </div>
        <div class="section-40">
          <h4 class="heading">Joystick Input</h4>

          <canvas id="joystickCanvas" width="240" height="120" style="border: 1px solid #dddddd"></canvas>
        </div>

        <div class="section-30">
          <h4 class="heading">Camera Feed</h4>
          <img id="camera-feed" width="160" height="120" />
        </div>
      </div>
    </div>

    <div class="section">
      <h4 class="heading">Console</h4>

      <div id="console-container" class="console-container"></div>

      <button class="action-button" onclick="clearConsole()">Clear</button>
      <button class="action-button" onclick="sendJsonData('/calibrate', '')">Calibrate</button>
      <button class="action-button" onclick="exportData()" id="export-data-button">Export Data</button>

      <h4 class="heading">Drone Data</h4>

      <div>
        <input type="checkbox" id="hideall" />
        <label for="hideall">Show all</label>
      </div>

      <canvas id="drone-data-chart" style="width: 100%; max-width: 700px"></canvas>
    </div>
  </div>
</body>

<script src="js/camera.js"></script>
<script src="js/chart.js"></script>
<script src="js/console.js"></script>
<script src="js/joystick.js"></script>
<script src="js/model-viewer.js"></script>
<script src="js/params.js"></script>
<script src="js/serial.js"></script>

<script type="module">
  /* WEB SOCKET */
  import { MSG_TYPES } from "/js/message_types.js";

  let webSocket = new WebSocket("ws://localhost:3000/comms");

  webSocket.addEventListener("open", (event) => {
    console_log("web", "Connected to ws");
    webSocket.send("Hello from browser");
  });

  webSocket.addEventListener("message", (event) => {
    let jsonData;

    try {
      jsonData = JSON.parse(event.data);
    } catch {
      updateCameraFrame(event.data);
      return;
    }

    const { msg_type, data } = jsonData;

    if (msg_type == MSG_TYPES.SERIAL_COMMS_MSG) {
      console_log("drone", data);
      return;
    }

    if (msg_type == MSG_TYPES.SERIAL_DRONE_DATA) {
      updateChart(data);
      const roll = data[data.length - 1].roll;
      const pitch = data[data.length - 1].pitch;
      const yaw = data[data.length - 1].yaw;
      updateModelViewer(roll, pitch, yaw);
      return;
    }

    if (msg_type == MSG_TYPES.SERIAL_JOYSTICK) {
      drawJoystick(data.lx, -data.ly, data.rx, -data.ry);
      return;
    }

    if (msg_type == MSG_TYPES.SERIAL_RECEIVE_DRONE_PARAMS) {
      console_log("web", "Obtained PID params from drone: " + data);
      load_params_from_arr(data);
      return;
    }
  });

  function sendJsonData(endpoint, data) {
    // Invoke server endoint with data
    fetch(endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ data: data }),
    });
  }

  /* DRONE PARAMS */

  // Save params button
  document.getElementById("update_params").addEventListener("click", () => {
    const params = getCurrentStabiliserParams();
    localStorage.setItem("pid_params", JSON.stringify(params));
    sendJsonData("/params", params);
    console_log("web", "Saved drone params to local storage: " + params);
  });

  // Load params button
  document.getElementById("obtain_params").addEventListener("click", () => {
    sendJsonData("/obtain_params", "");
  });

  // Load pid params on reload
  const drone_params_str = localStorage.getItem("pid_params");
  if (drone_params_str) {
    const pid_params = JSON.parse(drone_params_str);
    load_params_from_arr(pid_params);
    console_log("web", "PID params loaded from local storage");
  } else {
    console_log("web", "No PID params to load");
  }
</script>
